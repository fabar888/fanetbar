<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>天朗网吧专属上网码</title>
    <style>
        
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 18px;
            font-family: Arial, "Microsoft YaHei", sans-serif;
            z-index: 9999;
        }
        #loading.hidden {
            display: none;
        }
        
        #error {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            z-index: 9999;
        }
        #error.show {
            display: flex;
        }
        .error-content {
            background: white;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-width: 600px;
            margin: 20px;
        }
        @media (max-width: 480px) {
            .error-content {
                padding: 20px;
                margin: 10px;
            }
            #loading {
                font-size: 16px;
                padding: 20px;
            }
        }
        .error-content h1 {
            color: #f56c6c;
            margin-bottom: 20px;
            font-family: Arial, "Microsoft YaHei", sans-serif;
        }
        .error-content p {
            color: #666;
            line-height: 1.6;
            font-family: Arial, "Microsoft YaHei", sans-serif;
        }
        
        #content {
            width: 100%;
            min-height: 100vh;
            display: block;
        }
        
        #content > * {
            width: 100%;
        }
        
        @media (max-width: 480px) {
            html, body {
                font-size: 14px;
            }
            #content {
                padding: 5px !important;
            }
        }
    </style>
</head>
<body>
    <div id="loading">
        <div>正在加载二维码页面...</div>
    </div>
    <div id="error">
        <div class="error-content">
            <h1>⚠️ 加载失败</h1>
            <p id="error-message">无法从服务器获取页面内容</p>
        </div>
    </div>
    <div id="content"></div>

    <script>
        function decryptConfig(encrypted) {
            try {
                let decoded = atob(encrypted);
                decoded = decoded.split('').reverse().join('');
                let result = '';
                for (let i = 0; i < decoded.length; i++) {
                    result += String.fromCharCode(decoded.charCodeAt(i) - 1);
                }
                return result;
            } catch (e) {
                return '';
            }
        }
        
        const encryptedServer = 'NDU1OTt7enkve3p5e3t7ey9zYmMwMDt0cXV1aQ==';
        const encryptedPath = 'cXFiMA==';
        
        let BACKEND_SERVER = decryptConfig(encryptedServer);
        let API_BASE_PATH = decryptConfig(encryptedPath);
        
        if (!BACKEND_SERVER || BACKEND_SERVER === '' || BACKEND_SERVER.length < 10) {
            const step1 = 'https://bar.zzzzxyz.xyz:8443'.split('').map(c => String.fromCharCode(c.charCodeAt(0) + 1)).join('');
            const step2 = step1.split('').reverse().join('');
            BACKEND_SERVER = 'https://bar.zzzzxyz.xyz:8443';
        }
        if (!API_BASE_PATH || API_BASE_PATH === '' || !API_BASE_PATH.startsWith('/')) {
            API_BASE_PATH = '/app';
        }
        
        function getCustomIdFromUrl() {
            const path = window.location.pathname;
            const pathParts = path.split('/').filter(p => p);
            if (pathParts.length === 1 && pathParts[0] !== 'index.html') {
                return pathParts[0];
            } else if (pathParts.length === 2 && pathParts[0] === 'device') {
                return pathParts[1];
            }
            const params = new URLSearchParams(window.location.search);
            return params.get('custom_id') || params.get('id') || null;
        }
        function fetchWithTimeout(url, options = {}, timeout = 10000) {
            return new Promise((resolve, reject) => {
                const timer = setTimeout(() => {
                    reject(new Error(`请求超时（${timeout}ms）。可能是网络连接问题或服务器无响应。`));
                }, timeout);
                
                fetch(url, options)
                    .then(response => {
                        clearTimeout(timer);
                        resolve(response);
                    })
                    .catch(error => {
                        clearTimeout(timer);
                        reject(error);
                    });
            });
        }
        
        async function loadQRPage() {
            const customId = getCustomIdFromUrl();
            if (!customId) {
                document.getElementById('loading').classList.add('hidden');
                const errorDiv = document.getElementById('error');
                const errorMessage = document.getElementById('error-message');
                errorMessage.innerHTML = '请在URL中提供设备自定义ID（custom_id）<br><br>格式：<code>?custom_id=你的自定义ID</code> 或 <code>/你的自定义ID</code>';
                errorDiv.classList.add('show');
                return;
            }
            const apiUrl = `${BACKEND_SERVER}${API_BASE_PATH}/api/qr_page_by_custom_id/${encodeURIComponent(customId)}`;
            
            try {
                const response = await fetchWithTimeout(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html',
                    },
                    mode: 'cors',
                    credentials: 'omit',
                }, 10000);
                
                
                if (!response.ok) {
                    const errorText = await response.text().catch(() => '');
                    throw new Error(`服务器返回错误: ${response.status} ${response.statusText}\n${errorText.substring(0, 200)}`);
                }
                
                const html = await response.text();
                
                if (!html || html.trim().length === 0) {
                    throw new Error('服务器返回了空内容');
                }
                
                
                document.getElementById('loading').classList.add('hidden');
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const serverStyles = doc.head.querySelectorAll('style');
                serverStyles.forEach(style => {
                    const existingStyles = document.head.querySelectorAll('style');
                    let exists = false;
                    existingStyles.forEach(existing => {
                        if (existing.textContent === style.textContent) {
                            exists = true;
                        }
                    });
                    if (!exists) {
                        const newStyle = document.createElement('style');
                        let styleText = style.textContent;
                        styleText = styleText.replace(/^(\s*)body\s*\{/gm, '$1#content {');
                        styleText = styleText.replace(/(@media[^{]*\{[^}]*?)(\s*)body\s*\{/g, function(match, mediaQuery, indent) {
                            return mediaQuery + indent + '#content {';
                        });
                        newStyle.textContent = styleText;
                        document.head.appendChild(newStyle);
                    }
                });
                const serverBody = doc.body;
                const contentDiv = document.getElementById('content');
                if (serverBody) {
                    contentDiv.innerHTML = '';
                    while (serverBody.firstChild) {
                        contentDiv.appendChild(serverBody.firstChild);
                    }
                } else {
                    contentDiv.innerHTML = html;
                }
                contentDiv.style.display = 'flex';
                contentDiv.style.justifyContent = 'center';
                contentDiv.style.alignItems = 'center';
                contentDiv.style.minHeight = '100vh';
                contentDiv.style.margin = '0';
                contentDiv.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                contentDiv.style.padding = '10px';
                contentDiv.style.fontFamily = 'Arial, "Microsoft YaHei", sans-serif';
                contentDiv.style.boxSizing = 'border-box';
                
            } catch (error) {
                
                
                document.getElementById('loading').classList.add('hidden');
                
                
                const errorDiv = document.getElementById('error');
                const errorMessage = document.getElementById('error-message');
                
                let errorText = `无法从服务器获取页面内容\n\n`;
                errorText += `错误类型: ${error.name}\n`;
                errorText += `错误信息: ${error.message}\n\n`;
                
                
                if (error.message.includes('超时') || error.message.includes('timeout')) {
                    errorText += `⚠️ 请求超时，请检查网络连接。`;
                } else if (error.message.includes('CORS') || error.message.includes('fetch') || error.name === 'TypeError') {
                    errorText += `⚠️ 网络请求失败，请检查配置。`;
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorText += `⚠️ 网络连接失败，请检查网络设置。`;
                } else {
                    errorText += `⚠️ 发生错误，请查看浏览器控制台获取详细信息。`;
                }
                
                
                errorMessage.innerHTML = errorText.replace(/\n/g, '<br>');
                errorDiv.classList.add('show');
            }
        }
        
        window.addEventListener('DOMContentLoaded', function() {
            loadQRPage();
        });
        
        window.addEventListener('error', function(event) {
            if (event.error && event.error.message) {
                const errorDiv = document.getElementById('error');
                const errorMessage = document.getElementById('error-message');
                if (errorDiv && !errorDiv.classList.contains('show')) {
                    document.getElementById('loading').classList.add('hidden');
                    errorMessage.innerHTML = `发生未处理的错误: ${event.error.message}<br><br>请打开浏览器控制台（F12）查看详细信息。`;
                    errorDiv.classList.add('show');
                }
            }
        });
        
        window.addEventListener('unhandledrejection', function(event) {
            const errorDiv = document.getElementById('error');
            const errorMessage = document.getElementById('error-message');
            if (errorDiv && !errorDiv.classList.contains('show')) {
                document.getElementById('loading').classList.add('hidden');
                const errorMsg = event.reason && event.reason.message ? event.reason.message : String(event.reason);
                errorMessage.innerHTML = `发生未处理的错误: ${errorMsg}<br><br>请打开浏览器控制台（F12）查看详细信息。`;
                errorDiv.classList.add('show');
            }
        });
        
        
        
    </script>
</body>
</html>


